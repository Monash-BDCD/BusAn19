---
title: "BDCD Business Analytics Lab exercise"
author: "Prof Di Cook, with Steph Kobakian, Stuart Lee, Nick Spyrison"
date: "Econometrics & Bus Stat, Monash, Clayton campus, 22/2/2019"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  error = FALSE)
```

## Motivation

Be energy-wise, for a greener future. Climate change is consistently in the news. The consequences for Melbourne are more extreme high temperatures and drought. Individuals can play a big role in mitigating the extremes of the future, if they know how their actions contribute to the world as a whole. All of Melbourne households now have smart meters, which report the energy use every 30 minutes. 

## Task

Business analytics involves mathematics, computing and data. This lab exercise has a little of both. For the coding part, you will want to pretend you are a master cook, fashion designer, computer repairer or motor mechanic: copy, pull apart and put together again. 

We will show you how to download the smart meter data for your household, wrangle it into shape, and then how to make plots to explore household energy use. What times of day does the household use the most energy, or time of year? Is it related to the weather, with air conditioner or heater usage, or special events, like washing and drying clothes the night before a holiday trip, or dinner parties with friends. We will compare the usage across different households. All the tools used are open source software that will be available to you into the future.

## Getting started

### Reading

Point your web browser to this site: https://compare.energy.vic.gov.au. How can you earn $50 from your energy data?

What's a smart meter? Take a look at the web site http://www.smartmeters.vic.gov.au/# How many smart meters have been installed across Victoria?

### Get materials

Materials for the workshop can be downloaded from [https://github.com/Monash-BDCD/energy](https://github.com/Monash-BDCD/energy). It will download and unzip onto your computer with the name "energy-master", by default. **Change it to "energy".**

There are several files that will download:

- ```lab.Rmd``` (This is an Rmarkdown file, that has code and explanations, to compile into a document.)
- ```lab.html``` (This has the instructions for you to follow.)
- ```data``` is a directory containing some sample energy files
- ```energy_app``` contains files to make a web app
- ```energy.Rproj`` An R project, clicking on this will open RStudio (and R) on your computer.

### About the data

Data collected by downloading Di's (and friend of hers) electricity usage data as recorded by the household smart meter. Details on how to do this are (**THIS IS ONLY IF YOU WANT TO COLLECT YOUR OWN HOUSEHOLD'S DATA**): 

- [Find your distributor](https://www.energy.vic.gov.au/electricity/electricity-distributors) <br>
- Create an account, using your meter number which you can find on a current bill

Maybe after this workshop, you can do your own household, upload it to the [compare suppliers](https://compare.energy.vic.gov.au) site, claim your $50 (and get your parent to pay you this for your efforts), and possibly get a better deal on household energy costs.

### Resources

Cheat sheets are provided for:

- Rmarkdown
- Shiny
- Plotting data
- Wranging data

## Exercise 1: Background work

Read in Di's energy data. Look at the format of the data, and then rearrange it to a tidier format.

```{r fig.margin=TRUE, fig.width=3.5, fig.height=7}
library(tidyverse)
library(lubridate)
library(tsibble)
library(sugrrants)
library(glue)
library(emo)
elec <- read_csv("data/di.csv", skip=1,
                 col_names = c("id", "date", paste0("d", 1:48), paste0("stuff", 1:5)),
                 col_types = "ccddddddddddddddddddddddddddddddddddddddddddddddddccccc")
elec %>% head(10)
```

Here's the wrangling, `r set.seed(2016); emo::ji("workout")`, and new format:

```{r wrangle}
vic_holidays <- holiday_aus(2017:2019, state = "VIC")
elec <- elec %>% filter(id == 300)
elec <- elec %>%
  mutate(date = ymd(date)) %>%
  select(id:d48) %>%
  gather(halfhour, kwh, d1:d48) %>%
  mutate(halfhour = as.numeric(sub("d", "", halfhour))/2) %>%
  arrange(date, halfhour) %>%
  mutate(wday = wday(date, label = TRUE, abbr = TRUE,
                     week_start = 1),
         month = month(date, label = TRUE, abbr = TRUE),
         year = year(date)) %>%
  mutate(dt = ymd_hm(glue("{date} 12:00"),
                     tz = "Australia/Melbourne") +
           minutes(60*halfhour)) %>% 
  mutate(work = ifelse(wday %in% c("Mon", "Tue", "Wed", "Thu", "Fri"), "workday", "holiday")) %>%
  mutate(work = ifelse(date %in% vic_holidays$date, "holiday", work))
elec %>% head(15) 
```

## Exercise 2: Plot (some of) the data in a calendar layout


```{r fig.margin=TRUE, fig.width=3.5, fig.height=3.5}
p1 <- elec %>%
  filter(date < dmy("01022019"), date >= dmy("01122018")) %>%
  frame_calendar(x = halfhour, y = kwh, date = date, ncol = 4) %>%
  ggplot(aes(x = .halfhour, y = .kwh, group = date, colour=factor(work))) +
  geom_line() +
  scale_colour_brewer("work", palette = "Dark2") +
  theme(legend.position="none")
prettify(p1)
```

## Exercise 4: Combine with weather data

```{r fig.margin=TRUE, fig.width=3.5, fig.height=4}
library(bomrang)
library(viridis)
stations <- sweep_for_stations(latlon = c(-37.8136, 144.9631)) #Melbourne lat/long is 
maxtemp <- get_historical(stationid = "086282", type = "max") 
maxtemp <- maxtemp %>%  
  mutate(date = paste(maxtemp$Year, maxtemp$Month, maxtemp$Day, sep="-")) %>%
  mutate(date = ymd(date))
maxtemp_DF <- maxtemp %>% filter(Year > 2017, Month %in% c(12, 1)) 
p1 <- elec %>%
  filter(date < dmy("01022019"), date >= dmy("01122018")) %>%
  left_join(maxtemp_DF) %>% 
  frame_calendar(x = halfhour, y = kwh, date = date, ncol = 4) %>%
  ggplot(aes(x = .halfhour, y = .kwh, group = date, colour=Max_temperature)) +
  geom_line() +
  scale_colour_viridis_c("temperature", option="inferno", direction=-1) +
  theme(legend.position = "bottom")
prettify(p1)
```

## Making an interactive plot

```{r fig.width=5, fig.height=6}
library(plotly)
calendar_df <- elec %>%
  filter(date < ymd(max(elec$date)), date >= ymd(min(elec$date))) %>%
  frame_calendar(x = halfhour, y = kwh, date = date, ncol = 4) 
p <- calendar_df %>%
      group_by(date) %>%
      plot_ly(x = ~.halfhour, y = ~.kwh) %>%
      add_lines(text = ~ paste("KWH: ", kwh, "<br> Time: ", halfhour))
prettify(p)
```


## Exercise 5: Your turn to code

1. Easy tasks: 
    a. XXX
    b. XXX
2. Medium task: 
    a. XXX
    b. XXX
    c. XXX 
3. Difficult: Make a new app to study XXX. The steps to do this are:
    a. XXX 
    b. XXX  
    c. XXX

With your new app, XXX

## Turn in

Each group needs to provide to the instructor:

1. A document with answers to each of the questions
2. A copy of your app code

